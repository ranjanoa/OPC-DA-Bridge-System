<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPC DA Bridge Gateway</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #e2e8f0; height: 100vh; overflow: hidden; margin: 0; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .window-scroll::-webkit-scrollbar { width: 4px; }
        .window-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .glass { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); display: flex; flex-direction: column; overflow: hidden; }
    </style>
</head>
<body class="p-6 flex flex-col">
    <header class="w-full max-w-[1800px] mx-auto flex justify-between items-center mb-6 pb-4 border-b border-white/5 shrink-0">
        <div class="flex items-center space-x-4">
            <div class="bg-sky-500/10 p-2 rounded-lg border border-sky-500/20 text-sky-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
            </div>
            <h1 class="text-xl font-bold bg-gradient-to-r from-white to-slate-400 bg-clip-text text-transparent">Industrial Gateway</h1>
        </div>
        <div id="statusBadge" class="flex items-center space-x-2 px-3 py-1.5 rounded-full bg-slate-900 border border-white/5">
            <div id="statusLed" class="w-2 h-2 rounded-full bg-slate-600 transition-colors"></div>
            <span id="statusText" class="text-[9px] font-bold uppercase text-slate-500">Idle</span>
        </div>
    </header>

    <main class="w-full max-w-[1800px] mx-auto grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 h-[calc(100vh-120px)]">
        <div class="flex flex-col space-y-4">
            <section class="glass p-5 rounded-2xl shrink-0">
                <h2 class="text-[11px] font-bold uppercase text-sky-400 mb-4">OPC Connection</h2>
                <div class="space-y-3">
                    <input id="host" type="text" placeholder="Host IP" class="w-full bg-slate-950 border border-white/10 rounded-xl p-2.5 text-xs outline-none focus:border-sky-500">
                    <input id="progId" type="text" placeholder="ProgID" class="w-full bg-slate-950 border border-white/10 rounded-xl p-2.5 text-xs outline-none focus:border-sky-500">
                    <button onclick="browse()" class="w-full bg-sky-600 hover:bg-sky-500 py-2.5 rounded-xl font-bold text-xs transition-all active:scale-95">Discover Tags</button>
                </div>
            </section>
            <section class="glass p-5 rounded-2xl flex-grow flex flex-col overflow-hidden">
                <h2 class="text-[11px] font-bold uppercase text-emerald-400 mb-4">Database</h2>
                <div class="space-y-3 flex-grow overflow-y-auto pr-1 window-scroll">
                    <input id="token" type="password" placeholder="Token" class="w-full bg-slate-950 border border-white/10 rounded-xl p-2.5 text-xs outline-none">
                    <input id="org" type="text" placeholder="Org" class="w-full bg-slate-950 border border-white/10 rounded-xl p-2.5 text-xs outline-none">
                    <input id="bucket" type="text" placeholder="Bucket" class="w-full bg-slate-950 border border-white/10 rounded-xl p-2.5 text-xs outline-none">
                    <button onclick="startBridge()" class="w-full bg-emerald-600 hover:bg-emerald-500 py-2.5 rounded-xl font-bold text-xs shadow-lg shadow-emerald-900/20">Start Bridge</button>
                    <button onclick="stopBridge()" class="w-full bg-slate-800 py-2.5 rounded-xl font-bold text-[10px] text-slate-400">Stop</button>
                </div>
            </section>
        </div>

        <div class="glass rounded-2xl h-full shadow-2xl overflow-hidden flex flex-col">
            <div class="p-4 border-b border-white/5 bg-white/5"><h2 class="text-[11px] font-bold uppercase text-amber-500">Address Space</h2></div>
            <div id="tree" class="flex-grow p-4 mono text-[11px] window-scroll overflow-y-auto"></div>
        </div>

        <div class="glass rounded-2xl h-full shadow-2xl overflow-hidden flex flex-col">
            <div class="p-4 border-b border-white/5 bg-white/5 flex justify-between items-center">
                <h2 class="text-[11px] font-bold uppercase text-fuchsia-400">Actuation Map</h2>
                <button onclick="exportToCSV()" class="text-slate-500 hover:text-white text-[10px] uppercase font-bold">Export CSV</button>
            </div>
            <div id="mappingList" class="flex-grow p-4 space-y-3 window-scroll overflow-y-auto"></div>
        </div>

        <div class="glass rounded-2xl h-full shadow-2xl overflow-hidden flex flex-col">
            <div class="p-4 border-b border-white/5 bg-white/5"><h2 class="text-[11px] font-bold uppercase text-indigo-400">Live Telemetry (kiln1)</h2></div>
            <div id="monitor" class="flex-grow p-4 space-y-2 window-scroll overflow-y-auto"></div>
        </div>
    </main>

    <script>
        const BASE_URL = "http://localhost:5005";
        let selectedTagsMetadata = {};
        let isBridgeRunning = false;

        window.onload = loadConfig;

        async function loadConfig() {
            try {
                const res = await fetch(`${BASE_URL}/api/config`);
                if (res.ok) {
                    const cfg = await res.json();
                    document.getElementById('host').value = cfg.opcHost || 'localhost';
                    document.getElementById('progId').value = cfg.opcProgId || '';
                    document.getElementById('token').value = cfg.influxToken || '';
                    document.getElementById('org').value = cfg.influxOrg || '';
                    document.getElementById('bucket').value = cfg.influxBucket || '';
                    if (cfg.readTags) {
                        cfg.readTags.forEach(id => {
                            let alias = id;
                            if (cfg.writeMapping) {
                                for (let key in cfg.writeMapping) if (cfg.writeMapping[key] === id) alias = key;
                            }
                            selectedTagsMetadata[id] = { influxField: alias };
                        });
                        renderMappingUI();
                    }
                }
            } catch (e) {}
            checkLive();
        }

        async function removeTag(tagId) {
            if (!confirm(`Remove ${tagId}?`)) return;
            try {
                const res = await fetch(`${BASE_URL}/api/config/tag?tagId=${encodeURIComponent(tagId)}`, { method: 'DELETE' });
                if (res.ok) {
                    delete selectedTagsMetadata[tagId];
                    renderMappingUI();
                }
            } catch (e) { alert("Delete failed"); }
        }

        async function browse(nodeId = null) {
            if (nodeId) {
                const childContainer = document.getElementById(`child-${nodeId}`);
                const folderIcon = document.getElementById(`icon-${nodeId}`);
                if (childContainer && childContainer.innerHTML.trim() !== "") {
                    childContainer.innerHTML = "";
                    if (folderIcon) folderIcon.innerText = "üìÅ";
                    return; 
                }
            }

            const host = document.getElementById('host').value, progId = document.getElementById('progId').value;
            try {
                const res = await fetch(`${BASE_URL}/api/browse?host=${host}&progId=${progId}${nodeId ? '&nodeId='+encodeURIComponent(nodeId) : ''}`);
                const data = await res.json();
                const container = nodeId ? document.getElementById(`child-${nodeId}`) : document.getElementById('tree');
                container.innerHTML = ''; 

                data.forEach(item => {
                    const div = document.createElement('div');
                    div.className = "pl-4 border-l border-white/5 my-1";
                    div.innerHTML = `<div class="flex items-center space-x-2">
                        ${item.type === 'folder' ? 
                            `<button id="icon-${item.id}" class="text-sky-400" onclick="browse('${item.id}')">üìÅ</button>` : 
                            `<input type="checkbox" onchange="toggleTag('${item.id}', this.checked)" ${selectedTagsMetadata[item.id] ? 'checked' : ''}>`}
                        <span class="truncate text-slate-400 text-[10px]">${item.name}</span>
                    </div><div id="child-${item.id}"></div>`;
                    container.appendChild(div);
                });

                if (nodeId) {
                    const folderIcon = document.getElementById(`icon-${nodeId}`);
                    if (folderIcon) folderIcon.innerText = "üìÇ";
                }
            } catch (err) {}
        }

        function toggleTag(id, isChecked) {
            if (isChecked) selectedTagsMetadata[id] = { influxField: id };
            else delete selectedTagsMetadata[id];
            renderMappingUI();
        }

        function renderMappingUI() {
            const container = document.getElementById('mappingList');
            const entries = Object.entries(selectedTagsMetadata);
            if (!entries.length) { container.innerHTML = `<p class="text-[10px] text-slate-600 text-center mt-10">No tags mapped</p>`; return; }
            container.innerHTML = entries.map(([id, meta]) => `
                <div class="bg-slate-950 p-3 rounded-xl border border-white/5 group relative">
                    <button onclick="removeTag('${id}')" class="absolute top-2 right-2 text-slate-700 hover:text-rose-500 text-xs">‚úï</button>
                    <div class="text-[8px] text-slate-600 uppercase font-black truncate mb-1 pr-6">${id}</div>
                    <input type="text" value="${meta.influxField}" oninput="selectedTagsMetadata['${id}'].influxField=this.value" class="w-full bg-slate-900 border border-white/5 rounded-lg p-1.5 text-[10px] text-slate-200 outline-none">
                </div>`).join('');
        }

        async function startBridge() {
            const config = {
                opcHost: document.getElementById('host').value,
                opcProgId: document.getElementById('progId').value,
                influxUrl: "http://localhost:8086",
                influxToken: document.getElementById('token').value,
                influxOrg: document.getElementById('org').value,
                influxBucket: document.getElementById('bucket').value,
                readTags: Object.keys(selectedTagsMetadata),
                writeMapping: Object.fromEntries(Object.entries(selectedTagsMetadata).map(([id, m]) => [m.influxField, id]))
            };
            const res = await fetch(`${BASE_URL}/api/bridge/start`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(config) });
            if (res.ok) { isBridgeRunning = true; updateStatus(); }
        }

        async function stopBridge() { await fetch(`${BASE_URL}/api/bridge/stop`, { method: 'POST' }); isBridgeRunning = false; updateStatus(); }

        function updateStatus() {
            const led = document.getElementById('statusLed'), text = document.getElementById('statusText');
            led.className = `w-2 h-2 rounded-full ${isBridgeRunning ? 'bg-emerald-500 animate-pulse' : 'bg-slate-600'}`;
            text.innerText = isBridgeRunning ? "Active" : "Idle";
            text.className = `text-[9px] font-bold uppercase ${isBridgeRunning ? 'text-emerald-500' : 'text-slate-500'}`;
        }

        async function checkLive() {
            try {
                const res = await fetch(`${BASE_URL}/api/live`);
                const data = await res.json();
                const container = document.getElementById('monitor');
                const entries = Object.entries(data);
                if (entries.length) {
                    if (!isBridgeRunning) { isBridgeRunning = true; updateStatus(); }
                    container.innerHTML = entries.map(([k, v]) => `
                        <div class="flex justify-between items-center p-2 bg-slate-950/50 rounded-lg border border-white/5 group">
                            <span class="text-[9px] text-slate-300 truncate w-32">${k.split('.').pop()}</span>
                            <div class="flex items-center space-x-2">
                                <span class="mono text-[11px] font-bold text-sky-400">${typeof v === 'number' ? v.toFixed(2) : v}</span>
                                <button onclick="removeTag('${k}')" class="text-slate-700 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity">‚úï</button>
                            </div>
                        </div>`).join('');
                }
            } catch(e) {}
            setTimeout(checkLive, 1000);
        }

        function exportToCSV() {
            const data = Object.entries(selectedTagsMetadata).map(([id, meta]) => `"${id}","${meta.influxField}"`).join("\n");
            const blob = new Blob(["OPC_Tag,Influx_Field\n" + data], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.setAttribute('href', url); a.setAttribute('download', 'opc_config.csv'); a.click();
        }
    </script>
</body>
</html>